# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Development Commands

```bash
# Install dependencies
npm install

# Start Convex dev server (run in separate terminal)
npx convex dev

# Start Next.js development server
npm run dev

# Build for production
npm run build

# Run production build
npm start

# Lint code
npm run lint

# Import data from Supabase export (one-time migration)
npm run import-data
```

## Environment Setup

`.env.local` (auto-generated by `npx convex dev`):
```env
NEXT_PUBLIC_CONVEX_URL=https://your-project.convex.cloud
```

## Architecture Overview

### Technology Stack

- **Frontend**: Next.js 16 with React 19, TypeScript
- **Backend**: Convex (real-time backend-as-a-service)
- **Auth**: Convex Auth with password provider
- **Styling**: Tailwind CSS v4, shadcn/ui components
- **State**: Zustand with Immer middleware for optimistic updates

### Authentication & Data Flow

1. **Auth Layer**: Convex Auth handles user authentication (email/password)
   - `@convex-dev/auth` package provides authentication hooks
   - `useConvexAuth()` - Check authentication state
   - `useAuthActions()` - Sign in/out actions
   - Session managed automatically by Convex

2. **Data Layer**: Convex queries and mutations
   - Queries are in `convex/*.ts` files (users.ts, budgets.ts, categories.ts, allocations.ts, insights.ts)
   - Use `useQuery(api.module.queryName)` for real-time data fetching
   - Use `useMutation(api.module.mutationName)` for data mutations
   - All queries/mutations automatically re-run on data changes

3. **State Management**: Zustand store (`src/stores/budget-store.ts`) provides:
   - Optimistic UI updates during allocation changes
   - Real-time computed values (remaining budget, total allocated, etc.)
   - Uses Immer middleware for immutable updates
   - Getters are functions to ensure real-time calculation on each render

### Convex Schema (convex/schema.ts)

- **users**: User profile with email and currency preference
- **budgetMonths**: Budget for a specific month (income, savingsRate, adjustmentReason)
  - Index: `by_user_year_month` for efficient lookup
- **categories**: Budget categories per user
  - `isSavings` flag marks the special Savings category (cannot be deleted)
  - Index: `by_user` for user's categories
- **allocations**: Links BudgetMonth to Category with amount
  - Index: `by_budget_month_category` for unique allocation per category per month

### Savings Rate Logic

- Default savings rate: 20% (0.20)
- If user sets rate < 20%, `adjustmentReason` field becomes required (min 10 characters)
- Validation happens in:
  - Zod schema: `src/lib/validators.ts` (savingsRateSchema)
  - Convex mutation: `convex/budgets.ts` (updateSavingsRate)
- Constant `MIN_SAVINGS_RATE = 0.20` defined in `src/lib/utils.ts`

### Current vs Historical Months

- Only the current month (based on today's date) is editable
- Past months are automatically read-only
- `getCurrentMonth()` utility in `src/lib/utils.ts` determines current year/month
- Route `/budget/[year]/[month]` shows historical months in read-only mode
- Main dashboard shows current month

### Auto-Creation of Months

- `getOrCreateBudgetMonth()` in `convex/budgets.ts` creates missing months on first access
- New months automatically copy income and allocations from the most recent budget month
- Default categories are created during user signup (see `convex/users.ts`)

## Code Patterns

### Convex Query Pattern

```typescript
"use client";

import { useQuery } from "convex/react";
import { api } from "../../convex/_generated/api";

export function MyComponent() {
  const data = useQuery(api.budgets.getBudgetMonth, { year: 2026, month: 1 });

  if (data === undefined) {
    return <Loading />;
  }

  return <div>{data.income}</div>;
}
```

### Convex Mutation Pattern

```typescript
"use client";

import { useMutation } from "convex/react";
import { api } from "../../convex/_generated/api";
import type { Id } from "../../convex/_generated/dataModel";

export function MyComponent() {
  const updateIncome = useMutation(api.budgets.updateIncome);

  async function handleUpdate() {
    await updateIncome({
      budgetMonthId: "id123" as Id<"budgetMonths">,
      income: 5000,
    });
  }
}
```

### Server-Side Auth Check Pattern

In Convex functions, always verify the user is authenticated:

```typescript
import { mutation, query } from "./_generated/server";
import { getAuthUserId } from "@convex-dev/auth/server";

export const myQuery = query({
  handler: async (ctx) => {
    const userId = await getAuthUserId(ctx);
    if (!userId) {
      throw new Error("Not authenticated");
    }
    // ... rest of the query
  },
});
```

### Zustand Store Updates

Store uses Immer middleware for immutable updates. Update pattern:

```typescript
set((state) => {
  if (state.budgetMonth) {
    state.budgetMonth.income = newValue;
  }
});
```

Computed values are functions, not properties:
```typescript
const remaining = useBudgetStore((s) => s.getRemaining()); // Call the function
```

## Path Aliases

TypeScript path alias `@/*` maps to `./src/*` (configured in tsconfig.json).

Always use `@/` imports for src files:
```typescript
import { formatCurrency } from "@/lib/utils";
import { Button } from "@/components/ui/button";
```

For Convex imports, use relative paths:
```typescript
import { api } from "../../convex/_generated/api";
import type { Id } from "../../convex/_generated/dataModel";
```

## Important Constants

- `MIN_SAVINGS_RATE = 0.20` - Minimum required savings rate (20%)
- Supported currencies: SLE (default), USD, GBP, EUR, NGN (see `src/lib/validators.ts`)
- Default categories created on signup: Savings, Transport & Food, Utilities, Partner & Child Support, Subscriptions, Fun, Remittance

## Convex Development

After modifying `convex/schema.ts`:
- The schema is automatically pushed when running `npx convex dev`
- Types are auto-generated in `convex/_generated/`
- No manual migration steps needed - Convex handles schema changes automatically

To add a new query/mutation:
1. Create or edit a file in `convex/` directory
2. Export a `query` or `mutation` using the Convex helpers
3. The API is automatically available via `api.filename.functionName`
